name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  build_test_and_gates:
    name: Build, Test & Gates
    runs-on: ubuntu-latest

    env:
      SOLUTION_PATH: templates/FreyaTemplate/Freya.Template.sln
      API_PROJECT_PATH: templates/FreyaTemplate/src/Project.Api/Project.Api.csproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (10)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.103"
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/*.props
            **/*.targets
            global.json

      # If you commit packages.lock.json files, switch to:
      # dotnet restore $SOLUTION_PATH --locked-mode
      - name: Restore
        run: dotnet restore $SOLUTION_PATH

      - name: Build (Release)
        run: dotnet build $SOLUTION_PATH -c Release --no-restore

      - name: Test (Release) with TRX
        run: dotnet test $SOLUTION_PATH -c Release --no-build --logger "trx;LogFileName=test_results.trx" --results-directory ./artifacts/test-results

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: artifacts/test-results/**/*.trx
          if-no-files-found: warn

      - name: Dependency snapshot (transitive, JSON)
        run: |
          mkdir -p artifacts/dependencies
          dotnet list $SOLUTION_PATH package --include-transitive --format json > artifacts/dependencies/dependencies.json

      - name: Upload dependency snapshot
        uses: actions/upload-artifact@v4
        with:
          name: dependencies
          path: artifacts/dependencies/dependencies.json
          if-no-files-found: error

      - name: Vulnerability gate (fail on High/Critical)
        shell: bash
        run: |
          set -euo pipefail

          echo "Running vulnerability check (include transitive)..."
          OUT="$(dotnet list $SOLUTION_PATH package --vulnerable --include-transitive || true)"

          echo "$OUT"

          if echo "$OUT" | grep -Eiq "\b(High|Critical)\b"; then
            echo "❌ Vulnerability gate failed: High/Critical vulnerabilities detected."
            exit 1
          fi

          echo "✅ Vulnerability gate passed (no High/Critical)."

      - name: Install CycloneDX .NET tool
        shell: bash
        run: |
          set -euo pipefail
          dotnet tool update --global CycloneDX || dotnet tool install --global CycloneDX

      - name: Add .NET tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Generate SBOM (CycloneDX JSON)
        run: |
          mkdir -p artifacts/sbom
          dotnet-CycloneDX $SOLUTION_PATH -o artifacts/sbom -fn bom.json -t

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: artifacts/sbom/bom.json
          if-no-files-found: error

      - name: Generate license snapshot
        run: |
          mkdir -p artifacts/licenses
          dotnet list $SOLUTION_PATH package --include-transitive --format json > artifacts/licenses/packages.json

      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: License policy gate
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking licenses against policy..."

          POLICY_FILE="build/license-policy.json"
          PACKAGES_FILE="artifacts/licenses/packages.json"

          if [ ! -f "$POLICY_FILE" ]; then
            echo "❌ Policy file not found: $POLICY_FILE"
            exit 1
          fi

          FORBIDDEN=$(jq -r '.forbidden[]' "$POLICY_FILE")
          LICENSES=$(jq -r '.. | .license? // empty' "$PACKAGES_FILE" | sort -u)

          echo "Detected licenses:"
          echo "$LICENSES"

          for bad in $FORBIDDEN; do
            if echo "$LICENSES" | grep -iq "$bad"; then
              echo "❌ Forbidden license detected: $bad"
              exit 1
            fi
          done

          echo "✅ License policy gate passed."

      - name: Upload license snapshot
        uses: actions/upload-artifact@v4
        with:
          name: licenses
          path: artifacts/licenses/packages.json
          if-no-files-found: error

      # -----------------------------
      # Reproducible builds (verify)
      # -----------------------------
      - name: Reproducible publish #1
        shell: bash
        run: |
          set -euo pipefail
          rm -rf artifacts/release1 artifacts/release2
          mkdir -p artifacts/release1 artifacts/release2

          dotnet publish $API_PROJECT_PATH \
            -c Release \
            -o artifacts/release1 \
            --no-restore \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true

      - name: Reproducible publish #2 (clean)
        shell: bash
        run: |
          set -euo pipefail
          dotnet clean $SOLUTION_PATH -c Release

          dotnet publish $API_PROJECT_PATH \
            -c Release \
            -o artifacts/release2 \
            --no-restore \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true

      - name: Compare SHA256 (reproducibility gate)
        shell: bash
        run: |
          set -euo pipefail

          (cd artifacts/release1 && find . -type f -print0 | sort -z | xargs -0 sha256sum) > artifacts/release1.sha256
          (cd artifacts/release2 && find . -type f -print0 | sort -z | xargs -0 sha256sum) > artifacts/release2.sha256

          if ! diff -u artifacts/release1.sha256 artifacts/release2.sha256; then
            echo "❌ Reproducibility gate failed: publish outputs differ."
            exit 1
          fi

          echo "✅ Reproducibility gate passed: outputs are identical."

      - name: Upload release artifacts (release1)
        uses: actions/upload-artifact@v4
        with:
          name: release
          path: artifacts/release1
          if-no-files-found: error

      - name: Upload reproducibility evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reproducibility-evidence
          path: |
            artifacts/release1.sha256
            artifacts/release2.sha256
          if-no-files-found: warn

      - name: Generate SLSA provenance attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: artifacts/release1/**